<!DOCTYPE html>
<html>

<head>
  <title>TailTrail WebSocket Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    input,
    button {
      padding: 8px;
      margin: 5px;
    }

    input[type="text"],
    input[type="password"] {
      width: 300px;
    }

    #messages {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #f5f5f5;
      font-family: monospace;
      font-size: 12px;
    }

    .message {
      margin: 5px 0;
      padding: 5px;
      border-radius: 4px;
    }

    .sent {
      background: #e3f2fd;
    }

    .received {
      background: #f1f8e9;
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }

    .info {
      background: #fff3e0;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
    }

    .connected {
      background: #4caf50;
      color: white;
    }

    .disconnected {
      background: #f44336;
      color: white;
    }
  </style>
</head>

<body>
  <h1>üêæ TailTrail WebSocket Test</h1>

  <div class="container">
    <h2>1Ô∏è‚É£ Authentication</h2>
    <div>
      <input type="text" id="email" placeholder="Email" value="test@example.com">
      <input type="password" id="password" placeholder="Password" value="password123">
      <button onclick="login()">Login</button>
      <button onclick="register()">Register</button>
    </div>
    <div id="authStatus"></div>
  </div>

  <div class="container">
    <h2>2Ô∏è‚É£ WebSocket Connection</h2>
    <div>
      <span class="status disconnected" id="wsStatus">Disconnected</span>
      <button onclick="connectWS()" id="connectBtn">Connect</button>
      <button onclick="disconnectWS()" disabled id="disconnectBtn">Disconnect</button>
    </div>
  </div>

  <div class="container">
    <h2>3Ô∏è‚É£ Test Actions</h2>
    <button onclick="requestChatList()" disabled id="chatListBtn">Request Chat List</button>
    <button onclick="sendTestMessage()" disabled id="testMsgBtn">Send Test Message</button>
  </div>

  <div class="container">
    <h2>üìã Messages</h2>
    <button onclick="clearMessages()">Clear</button>
    <div id="messages"></div>
  </div>

  <script>
    let ws = null;
    let token = null;
    let userId = null;
    const baseUrl = 'http://209.38.237.102:8080';

    function log(message, type = 'info') {
      const messagesDiv = document.getElementById('messages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }

    async function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${baseUrl}/api/v1/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.text();
        if (response.ok || data.includes('User created successfully')) {
          log('‚úÖ Registration successful! Now login.', 'info');
          document.getElementById('authStatus').innerHTML = '<p style="color: green;">Registered! Please login.</p>';
        } else {
          log(`‚ùå Registration failed: ${data}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Registration error: ${error}`, 'error');
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${baseUrl}/api/v1/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (response.ok) {
          const data = await response.json();
          token = data.access_token || data.token;

          // Try to decode JWT to get user ID
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            userId = payload.user_id || payload.sub || 1;
          } catch {
            userId = 1; // Default
          }

          log(`‚úÖ Login successful! User ID: ${userId}`, 'info');
          document.getElementById('authStatus').innerHTML =
            `<p style="color: green;">Logged in! Token: ${token.substring(0, 20)}...</p>`;

          // Enable WebSocket button
          document.getElementById('connectBtn').disabled = false;
        } else {
          const error = await response.text();
          log(`‚ùå Login failed: ${error}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Login error: ${error}`, 'error');
      }
    }

    function connectWS() {
      if (!token) {
        log('‚ùå Please login first!', 'error');
        return;
      }

      const wsUrl = `ws://209.38.237.102:8080/api/v1/websocket/ws/${userId}`;
      log(`üîÑ Connecting to: ${wsUrl}`, 'info');

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log('‚úÖ WebSocket connected!', 'info');
        document.getElementById('wsStatus').textContent = 'Connected';
        document.getElementById('wsStatus').className = 'status connected';
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
        document.getElementById('chatListBtn').disabled = false;
        document.getElementById('testMsgBtn').disabled = false;

        // Send auth if needed
        ws.send(JSON.stringify({
          type: 'auth',
          data: { token: token }
        }));
      };

      ws.onmessage = (event) => {
        log(`üì® Received: ${event.data}`, 'received');
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'chat_list') {
            log(`   Found ${data.data.length} chats`, 'info');
          }
        } catch { }
      };

      ws.onerror = (error) => {
        log(`‚ùå WebSocket error: ${error}`, 'error');
      };

      ws.onclose = (event) => {
        log(`‚ùå WebSocket closed: ${event.code} - ${event.reason}`, 'error');
        document.getElementById('wsStatus').textContent = 'Disconnected';
        document.getElementById('wsStatus').className = 'status disconnected';
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('chatListBtn').disabled = true;
        document.getElementById('testMsgBtn').disabled = true;
      };
    }

    function disconnectWS() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }

    function requestChatList() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = JSON.stringify({
          type: 'list_chats',
          data: {}
        });
        ws.send(message);
        log(`üì§ Sent: ${message}`, 'sent');
      }
    }

    function sendTestMessage() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = JSON.stringify({
          type: 'ping',
          data: { message: 'Hello from browser!' }
        });
        ws.send(message);
        log(`üì§ Sent: ${message}`, 'sent');
      }
    }
  </script>
</body>

</html>